!function(t,e){var I,x,O,p,r,n,T,L,a,s,i,o,c,l,u,d=(x=(I=t).document,O=I.setTimeout,I.setInterval,p=I.XMLHttpRequest,r=I.getComputedStyle,n=I.requestAnimationFrame,a=function(){},s=Object.create||function(t){function e(){}return e.prototype=t,new e},i=Array.prototype,o=Object.prototype,c=i.slice,l=c,u=o.toString,T={extend:function(t,e){var n=e._constructor||a;function r(){t.apply&&t.apply(this,arguments),n.apply(this,arguments)}delete e._constructor;var i=r.prototype=s(t.prototype);for(var o in e)e.hasOwnProperty(o)&&(i[o]=e[o]);return i.constructor=r},shallowCopy:function(){for(var t,e=arguments[0],n=Array.prototype.slice.call(arguments,1),r=0,i=n.length;r<i;r++)for(var o in t=n[r])e[o]=t[o];return e},ownsProperty:function(t,e){if(t.hasOwnProperty)return t.hasOwnProperty(e);var n=t[e];return void 0!==n&&t.constructor.prototype[e]!==n},slice:function(t,e,n){var r,i,o=t.length,a=e||0,s=n||o;if("[object Array]"===u.call(t))r=l.call(t,a,s);else for(s<0&&(s=o-s),r=[],i=a;i<s;i++)r[r.length]=t[i];return r},trim:function(t){return t.replace(/^\s+|\s+$/g,"")}},L=function(){var e={},p=!!I.ActiveXObject,v=/^\s*<(!--\s*.*)?(\w+)[^>]*>/,h=x.createElement("div"),t=x.createElement("table"),n=x.createElement("tr"),m={"*":h,tbody:t,tfoot:t,tr:x.createElement("tbody"),td:n,th:n},a=typeof("function"===I.Event);function o(t){return e[t]||(e[t]=new RegExp("(^|\\s+)"+t+"(?:\\s+|$)"))}function s(t,e){var n=t.classList;return!(!n||!e)&&(n.add(e),!0)}function c(t,e){var n=t.classList;return!(!n||!e)&&(n.remove(e),!0)}function l(t,e){return o(e).test(t.className)}function u(t,e,n){var r=x.createEvent("Event");return r.initEvent(t,n.bubbles,n.cancelable),r.srcElement=e,r}return{selectOne:function(t,e){return"string"==typeof t?(e||x).querySelector(t):t},select:function(t,e){return"string"==typeof t?(e||x).querySelectorAll(t):t},asFragment:function(t,e){var n,r,i,o,a,s,c,l,u;e||(r=v.exec(t),e=r?r[2]:null),n=(m[e]||h).cloneNode(),i=p?"tbody"===(o=n.tagName.toLowerCase())||"table"===o||"thead"===o||"tfoot"===o?(s="table",c=t,l=!0,u=h.cloneNode(),c+="",u.innerHTML=["<",s,">",c,"</",s,">"].join(""),l?u.firstChild.firstChild.childNodes:u.firstChild.childNodes):(n.innerHTML=""+t,n.childNodes):(n.innerHTML=""+t,n.childNodes),i=T.slice(i),a=x.createDocumentFragment();for(var d=0,f=i.length;d<f;d+=1)a.appendChild(i[d]);return a},dispatchEvent:function(e,n){var r,i=n.element||x,t=n.data;if(a)try{r=new Event(e,{bubbles:n.bubbles||!1,cancelable:n.cancelable||!1})}catch(t){r=u(e,i,n)}else r=u(e,i,n);for(var o in t)r[o]=t[o];i.dispatchEvent(r)},hasClass:l,addClass:function(t,e){var n;if(t.length)for(var r=0,i=t.length;r<i;r+=1)l(n=t[r],e)||s(n,e)||(n.className+=" "+e);else l(n=t,e)||s(n,e)||(n.className+=" "+e);return this},removeClass:function(t,e){var n;if(t.length)for(var r=0,i=t.length;r<i;r+=1)l(n=t[r],e)&&!c(n,e)&&(n.className=T.trim(n.className.replace(o(e),"$1")));else l(n=t,e)&&!c(n,e)&&(n.className=T.trim(n.className.replace(o(e),"$1")));return this},getComputedStyle:function(t){return r?r(t):t.currentStyle},data:function(t){var e=arguments[1],n=arguments[2],r=t.__stagedata__;return r||(r=t.__stagedata__={}),2===arguments.length?r[e]:(3===arguments.length&&(r[e]=n),this)}}}(),function(){var i,o,a,t,s,g={},y=n||I.mozRequestAnimationFrame||I.webkitRequestAnimationFrame||I.msRequestAnimationFrame||function(t){return O(t,1e3/60)},C=(i=["","Webkit","Moz","O","ms","MS"],o=["transitionend","webkitTransitionEnd","transitionend","oTransitionEnd","MSTransitionEnd"],a=["animationend","webkitAnimationEnd","animationend","oAnimationEnd","animationend"],t=x.createElement("div"),s=t.style,{transition:function(){for(var t,e,n=0,r=i.length;n<r;n+=1)if(void 0!==s[e=(t=i[n])?t+"Transition":"transition"])return{property:e,end:o[n]};return{}}(),animation:function(){for(var t,e,n=0,r=i.length;n<r;n+=1)if(void 0!==s[e=(t=i[n])?t+"Animation":"animation"])return{property:e,end:a[n]};return{}}()}),E={transitionDelay:100,transition:"slide"},u='<div class="stage-view"></div>',b="no-transition",V=/\.js$/;function k(t,e,n){var r=x.createElement("script");r.onerror=function(){n({error:!0,src:t})},"onreadystatechange"in r?r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||n({src:t})}:r.onload=function(){n({src:t})},r.src=t,r.async=1,e.appendChild(r)}function A(t,n,u){var e,r,i,o,a,s,c,l,d=t.path,f=t.id;e={path:d,method:"GET",success:function(t){var s=x.createElement("div"),e=L.asFragment(t.responseText),c=T.slice(L.select("script",e)).filter(function(t){var e=t.getAttribute("type")||"text/javascript";return-1!==e.indexOf("/javascript")}),l=function(t){var e,n,r,i,o,a;t&&t.error&&console.error("Error loading script",t.src,t.error),c.length?(e=c.shift(),(n=e.getAttribute("src"))?k(n,s,l):(r=e.textContent,i=s,(a=x.createElement("script")).textContent=o?"(function() {\n"+r+"\n})();":r,i.appendChild(a),l())):u({path:d,error:!1,element:s})};c.forEach(function(t){t.parentNode.removeChild(t)}),s.className="view-holder",s.setAttribute("data-view-id",f),s.setAttribute("data-view-template",d),s.appendChild(e),n.appendChild(s),l()},fail:function(t,e){u({path:d,error:t||!0,xhr:e})}},r=new p,i=!1,o=e.path,a=e.method||"GET",s=e.success,c=e.fail,l=void 0===e.timeout?3e4:e.timeout,r.open(a,o,!0),r.timeout=l,r.addEventListener("readystatechange",function(){var t,e=r.readyState;2!==e&&3!==e||(i=!0),4===e&&(200<=(t=r.status)&&t<400||0===t&&i?s&&s(r):c&&c(t,r))}),r.addEventListener("timeout",function(){c&&c("timeout",r)}),r.send()}function N(t,e){var n,r,i,o,a,s=t.id,c='[data-view="'+s+'"]',l='[data-view-template="'+t.path+'"]';return(r=L.selectOne(c,e))||(i=t.template||u,o=s,a=L.asFragment(i).firstChild,L.addClass(a,"stage-view"),a.setAttribute("data-view",o),r=a,n=L.selectOne(l,e),r=n?n.insertBefore(r,n.firstChild):e.appendChild(r))}function c(t){var e=g[t];return e||(e=g[t]={id:t}),e}function S(t,e,n){this.id=t,this.element=e,this.controller=n}function P(){}function e(t){var c,e,l=T.shallowCopy({},E,t),f=L.selectOne(l.viewport),u={},d=function(){var t,n,r,i=!1;function e(t){var e=L.getComputedStyle(t),n=e["transition-property"]||e["-webkit-transition-property"]||e["-moz-transitionProperty"];return n?n.split(",").length:0}return eventCount={},{name:function(){return arguments.length?(t=arguments[0],this):t},from:function(t){return n=t.id,eventCount[t.id]=e(t.element),this},to:function(t){return r=t.id,eventCount[t.id]=e(t.element),this},transitionEnded:function(t){var e;return eventCount[t.id]-=1,e=!eventCount[t.id],i=eventCount[n]||eventCount[r],e},inProgress:function(){return arguments.length?(i=arguments[0],this):i},clear:function(){delete eventCount[n],delete eventCount[r],i=!1,n=r=null}}}(),p=[];if(console.debug("Stage options ",l),!f||1!==f.nodeType)throw new Error("Use a valid element as view port");var n,r,i,v=l.transition;function o(t,e){var i,o=u[t],a="transition"in e?e.transition:v,n=function(){i&&m("out",i),m("in",o),y(function(){var t,e,n,r;i&&(e=a,(t=i).stack(),C.transition.end&&e||w({target:t.element,propertyName:b})),r=a,(n=o).bringIn(),C.transition.end&&r||w({target:n.element,propertyName:b})})};e.viewAction="push";var r=d.name();if(r!==a&&(d.name(a),r&&L.removeClass(f,r),L.addClass(f,a)),i=p.length?p[p.length-1]:null){if(i.id===t)return i.controller.update(e),void d.clear();d.from(i),e.fromView=i.id}L.addClass(f,"view-transitioning"),o?o.unStack().show(!0):((o=function(t){var e,n,r=g[t],i=N(r,f);if(i)return i.addEventListener(C.transition.end||"transitionend",w,!1),i.addEventListener(C.animation.end||"animationend",w,!1),e=T.extend(P,r.factory(c,i)),n=new e,u[t]=new S(t,i,n);throw new Error("UI for view "+t+" not found.")}(t)).show(!0),o.controller.initialize(e)),o.transition=a,d.to(o),i&&i.controller.deactivate(),p.push(o);var s=o.controller.activate;2===s.length?o.controller.activate(e,function(){O(n,l.transitionDelay)}):(o.controller.activate(e),O(n,l.transitionDelay))}function a(t,e){var i,o,n,r,a=d.name(),s=function(){m("out",i),m("in",o),y(function(){var t,e,n,r;e=a,(t=i).pop(),C.transition.end&&e||w({target:t.element,propertyName:b}),r=a,(n=o).unStack("unstack").bringIn(),C.transition.end&&r||w({target:n.element,propertyName:b})})};if(i=p[p.length-1],e){if(-1===(n=function(t){var e,n;for(e=0,n=p.lenth;e<n&&p[e].id!==t;e+=1);return e===n?-1:e}(e)))throw d.clear(),new Error("View "+e+" is not on stack");if(n===p.length-1)throw d.clear(),new Error("Cannot pop to the current view: "+e);o=p[n],r=n+1}else o=p[p.length-2];o.stack(),L.addClass(f,"view-transitioning"),o.show(!0),d.from(i).to(o),t.fromView=i.id,t.viewAction="pop",i.controller.deactivate(),e?p.splice(r,p.length-r):p.pop();var c=o.controller.activate;2===c.length?o.controller.activate(t,function(){O(s,l.transitionDelay)}):(o.controller.activate(t),O(s,l.transitionDelay))}function h(t,e,n){L.dispatchEvent("viewload"+t,{element:f,data:{viewId:e,error:n}})}function m(t,e){L.dispatchEvent("beforeviewtransition"+t,{element:f,cancelable:!0,data:{viewId:e.id}}),L.dispatchEvent("beforetransition"+t,{element:e.element})}function w(t){var e,n,r,i,o,a,s=t.target,c=s.getAttribute("data-view");c&&(e=u[c],d.transitionEnded(e)&&(e.isIn()?(e.wasUnStacked()&&e.reset("unstack"),n="in"):e.wasPopped()?(e.reset(["showing","pop"]),n="out"):e.isStacked()&&(e.show(!1),n="out"),o=n,a=e,L.dispatchEvent("viewtransition"+o,{element:f,data:{viewId:a.id}}),L.dispatchEvent("transition"+o,{element:a.element}),d.inProgress()||(d.clear(),L.removeClass(f,"view-transitioning"),r=d.name(),i=p[p.length-1],r!==i.transition&&(L.removeClass(f,r).addClass(f,i.transition),d.name(i.transition)))))}return v&&(L.addClass(f,v),d.name(v)),I.addEventListener("unload",function(){for(var t in u){var e=u[t];e&&e.controller&&e.controller.destroy()}}),n=e={getViewPort:function(){return f},pushView:function(e,t){var n=u[e],r=T.shallowCopy({},t);d.inProgress()?console.log("pushView() View transitioin in progress. Ignoring this call"):(d.inProgress(!0),n?o(e,r):this.loadView(e,function(t){t.error?(d.clear(),console.error("Error loading view",t)):o(e,r)}))},popView:function(t){var e=T.shallowCopy({},t),n=e.toView;if(d.inProgress())console.debug("popView() View transitioin in progress. Ignoring this call");else{if(p.length<2)throw new Error("Can't pop. One or less view(s)");d.inProgress(!0),a(e,n)}},currentView:function(){var t=p[p.length-1];return t?t.id:null},previousView:function(){var t;return 2<=p.length&&(t=p[p.length-2])?t.id:null},indexOfView:function(n){var r=-1;return p.some(function(t,e){return t.id===n&&(r=e,!0)}),r},isTransitionInProgress:function(){return d.inProgress()},loadView:function(e,n){var t,r=g[e],i=function(t){n({viewId:e,error:t.error,path:t.path}),h("end",e,t.error)};if(r){var o,a,s,c,l,u;r.factory?n({viewId:e}):(h("start",e),t=r.path,V.test(t)?(a=f,s=i,c=(o=r).id,l=o.path,(u=x.createElement("div")).className="view-holder",u.setAttribute("data-view-id",c),u.setAttribute("data-view-template",l),u=a.appendChild(u),k(l,u,function(t){s({path:t.src,element:u,error:t.error})})):A(r,f,i))}else{var d=new Error("View not defined: "+e);n({viewId:e,error:d})}},getViewController:function(t){return u[t].controller}},r=l.context||{},i=n,c={getViewPort:function(){return i.getViewPort()},pushView:function(t,e){return i.pushView(t,e)},popView:function(t){return i.popView(t)},currentView:function(){return i.currentView()},previousView:function(){return i.previousView()},context:function(){return r}},e}return S.prototype={constructor:S,show:function(t){return!1===t?L.removeClass(this.element,"showing"):L.addClass(this.element,"showing"),this},bringIn:function(){L.addClass(this.element,"in")},isIn:function(){return L.hasClass(this.element,"in")},stack:function(){return L.hasClass(this.element,"stack")||L.removeClass(this.element,"in").addClass(this.element,"stack"),this},isStacked:function(){return L.hasClass(this.element,"stack")},unStack:function(t){return L.removeClass(this.element,"stack"),t&&L.addClass(this.element,"unstack"),this},wasUnStacked:function(){return L.hasClass(this.element,"unstack")},pop:function(){return L.removeClass(this.element,"in").addClass(this.element,"pop"),this},wasPopped:function(){return L.hasClass(this.element,"pop")},reset:function(t){if("string"==typeof t)L.removeClass(this.element,t);else{var e=this;t.forEach(function(t){L.removeClass(e.element,t)})}}},P.prototype={constructor:P,initialize:function(){},activate:function(){},update:function(){},deactivate:function(){},destroy:function(){}},e.defineView=function(t,e){var n,r=t;"object"==typeof r&&(t=r.id,e=r.factory,n=r.template);var i=c(t);i.factory=e,i.template=n},e.views=function(t){for(var e in t)T.ownsProperty(t,e)&&(c(e).path=t[e])},e.view=function(t,e){var n=c(t);n.path=e},e}());"function"==typeof define&&define.amd?define(function(){return d}):"object"==typeof module&&module.exports?module.exports=d:t.Stage=d}("undefined"==typeof window?this:window);