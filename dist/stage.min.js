!function(t,e){var n=function(t,e){var n=t.document,r=t.setTimeout,i=(t.setInterval,t.XMLHttpRequest),o=t.getComputedStyle,a=t.requestAnimationFrame,s=(l=function(){},u=Object.create||function(t){function e(){}return e.prototype=t,new e},d=Array.prototype,f=Object.prototype,p=d.slice,v=f.toString,{extend:function(t,e){var n=e._constructor||l;function r(){t.apply&&t.apply(this,arguments),n.apply(this,arguments)}delete e._constructor;var i=r.prototype=u(t.prototype);for(var o in e)e.hasOwnProperty(o)&&(i[o]=e[o]);return i.constructor=r,r},shallowCopy:function(){for(var t,e=arguments[0],n=Array.prototype.slice.call(arguments,1),r=0,i=n.length;r<i;r++)for(var o in t=n[r])e[o]=t[o];return e},ownsProperty:function(t,e){if(t.hasOwnProperty)return t.hasOwnProperty(e);var n=t[e];return void 0!==n&&t.constructor.prototype[e]!==n},slice:function(t,e,n){var r,i,o=t.length,a=e||0,s=n||o;if("[object Array]"===v.call(t))r=p.call(t,a,s);else for(s<0&&(s=o-s),r=[],i=a;i<s;i++)r[r.length]=t[i];return r},trim:function(t){return t.replace(/^\s+|\s+$/g,"")}}),c=function(){var e={},r=!!t.ActiveXObject,i=/^\s*<(!--\s*.*)?(\w+)[^>]*>/,a=n.createElement("div"),c=n.createElement("table"),l=n.createElement("tr"),u={"*":a,tbody:c,tfoot:c,tr:n.createElement("tbody"),td:l,th:l},d=typeof("function"===t.Event);function f(t){return e[t]||(e[t]=new RegExp("(^|\\s+)"+t+"(?:\\s+|$)"))}function p(t,e){var n=t.classList;return!(!n||!e)&&(n.add(e),!0)}function v(t,e){var n=t.classList;return!(!n||!e)&&(n.remove(e),!0)}function h(t,e){return f(e).test(t.className)}function m(t,e,r){var i=n.createEvent("Event");return i.initEvent(t,r.bubbles,r.cancelable),i.srcElement=e,i}return{selectOne:function(t,e){return"string"==typeof t?(e||n).querySelector(t):t},select:function(t,e){return"string"==typeof t?(e||n).querySelectorAll(t):t},asFragment:function(t,e){var o,c,l,d,f;e||(e=(c=i.exec(t))?c[2]:null),o=(u[e]||a).cloneNode(),r&&("tbody"===(d=o.tagName.toLowerCase())||"table"===d||"thead"===d||"tfoot"===d)?l=function(t,e,n){var r=a.cloneNode();return e+="",r.innerHTML=["<",t,">",e,"</",t,">"].join(""),n?r.firstChild.firstChild.childNodes:r.firstChild.childNodes}("table",t,!0):(o.innerHTML=""+t,l=o.childNodes),l=s.slice(l),f=n.createDocumentFragment();for(var p=0,v=l.length;p<v;p+=1)f.appendChild(l[p]);return f},dispatchEvent:function(t,e){var r,i=e.element||n,o=e.data;if(d)try{r=new Event(t,{bubbles:e.bubbles||!1,cancelable:e.cancelable||!1})}catch(s){r=m(t,i,e)}else r=m(t,i,e);for(var a in o)r[a]=o[a];i.dispatchEvent(r)},hasClass:h,addClass:function(t,e){var n;if(t.length)for(var r=0,i=t.length;r<i;r+=1)h(n=t[r],e)||p(n,e)||(n.className+=" "+e);else h(n=t,e)||p(n,e)||(n.className+=" "+e);return this},removeClass:function(t,e){var n;if(t.length)for(var r=0,i=t.length;r<i;r+=1)h(n=t[r],e)&&!v(n,e)&&(n.className=s.trim(n.className.replace(f(e),"$1")));else h(n=t,e)&&!v(n,e)&&(n.className=s.trim(n.className.replace(f(e),"$1")));return this},getComputedStyle:function(t){return o?o(t):t.currentStyle},data:function(t){var e=arguments[1],n=arguments[2],r=t.__stagedata__;return r||(r=t.__stagedata__={}),2===arguments.length?r[e]:(3===arguments.length&&(r[e]=n),this)}}}();var l,u,d,f,p,v;return function(){var e,o,l,u,d={},f=a||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(t){return r(t,1e3/60)},p=(e=["","Webkit","Moz","O","ms","MS"],o=["transitionend","webkitTransitionEnd","transitionend","oTransitionEnd","MSTransitionEnd"],l=["animationend","webkitAnimationEnd","animationend","oAnimationEnd","animationend"],u=n.createElement("div").style,{transition:function(){for(var t,n,r=0,i=e.length;r<i;r+=1)if("undefined"!=typeof u[n=(t=e[r])?t+"Transition":"transition"])return{property:n,end:o[r]};return{}}(),animation:function(){for(var t,n,r=0,i=e.length;r<i;r+=1)if("undefined"!=typeof u[n=(t=e[r])?t+"Animation":"animation"])return{property:n,end:l[r]};return{}}()}),v={transitionDelay:100,transition:"slide"},h=/\.js$/;function m(t,e,r){var i=n.createElement("script");i.onerror=function(){r({error:!0,src:t})},"onreadystatechange"in i?i.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||r({src:t})}:i.onload=function(){r({src:t})},i.src=t,i.async=1,e.appendChild(i)}function w(t,e,r){var o=t.path,a=t.id;!function(t){var e=new i,n=!1,r=t.path,o=t.method||"GET",a=t.success,s=t.fail,c="undefined"==typeof t.timeout?3e4:t.timeout;e.open(o,r,!0),e.timeout=c,e.addEventListener("readystatechange",(function(){var t,r=e.readyState;2!==r&&3!==r||(n=!0),4===r&&((t=e.status)>=200&&t<400||0===t&&n?a&&a(e):s&&s(t,e))})),e.addEventListener("timeout",(function(){s&&s("timeout",e)})),e.send()}({path:o,method:"GET",success:function(t){var i=n.createElement("div"),l=c.asFragment(t.responseText),u=s.slice(c.select("script",l)).filter((function(t){return-1!==(t.getAttribute("type")||"text/javascript").indexOf("/javascript")})),d=function(t){var e,a;t&&t.error&&console.error("Error loading script",t.src,t.error),u.length?(a=(e=u.shift()).getAttribute("src"))?m(a,i,d):(!function(t,e,r){var i=n.createElement("script");i.textContent=r?"(function() {\n"+t+"\n})();":t,e.appendChild(i)}(e.textContent,i),d()):r({path:o,error:!1,element:i})};u.forEach((function(t){t.parentNode.removeChild(t)})),i.className="view-holder",i.setAttribute("data-view-id",a),i.setAttribute("data-view-template",o),i.appendChild(l),e.appendChild(i),d()},fail:function(t,e){r({path:o,error:t||!0,xhr:e})}})}function g(t,e){var n,r,i=t.id,o='[data-view="'+i+'"]',a='[data-view-template="'+t.path+'"]';return(r=c.selectOne(o,e))||(r=function(t,e){var n=c.asFragment(t).firstChild;return c.addClass(n,"stage-view"),n.setAttribute("data-view",e),n}(t.template||'<div class="stage-view"></div>',i),r=(n=c.selectOne(a,e))?n.insertBefore(r,n.firstChild):e.appendChild(r))}function y(t){var e=d[t];return e||(e=d[t]={id:t}),e}function C(t,e,n){this.id=t,this.element=e,this.controller=n}function E(){}function b(e){var i,o,a=s.shallowCopy({},v,e),l=c.selectOne(a.viewport),u={},y=function(){var t,e,n,r=!1;function i(t){var e=c.getComputedStyle(t),n=e["transition-property"]||e["-webkit-transition-property"]||e["-moz-transitionProperty"];return n?n.split(",").length:0}return eventCount={},{name:function(){return arguments.length?(t=arguments[0],this):t},from:function(t){return e=t.id,eventCount[t.id]=i(t.element),this},to:function(t){return n=t.id,eventCount[t.id]=i(t.element),this},transitionEnded:function(t){var i;return eventCount[t.id]-=1,i=!eventCount[t.id],r=eventCount[e]||eventCount[n],i},inProgress:function(){return arguments.length?(r=arguments[0],this):r},clear:function(){delete eventCount[e],delete eventCount[n],r=!1,e=n=null}}}(),b=[];if(console.debug("Stage options ",a),!l||1!==l.nodeType)throw new Error("Use a valid element as view port");var V=a.transition;function k(t,e){var n,o=u[t],v="transition"in e?e.transition:V,h=function(){n&&N("out",n),N("in",o),f((function(){n&&function(t,e){t.stack(),p.transition.end&&e||P({target:t.element,propertyName:"no-transition"})}(n,v),function(t,e){t.bringIn(),p.transition.end&&e||P({target:t.element,propertyName:"no-transition"})}(o,v)}))};e.viewAction="push";var m=y.name();if(m!==v&&(y.name(v),m&&c.removeClass(l,m),c.addClass(l,v)),n=b.length?b[b.length-1]:null){if(n.id===t)return n.controller.update(e),void y.clear();y.from(n),e.fromView=n.id}c.addClass(l,"view-transitioning"),o?o.unStack().show(!0):((o=function(t){var e,n=d[t],r=g(n,l);if(!r)throw new Error("UI for view "+t+" not found.");return r.addEventListener(p.transition.end||"transitionend",P,!1),r.addEventListener(p.animation.end||"animationend",P,!1),e=new(s.extend(E,n.factory(i,r))),u[t]=new C(t,r,e)}(t)).show(!0),o.controller.initialize(e)),o.transition=v,y.to(o),n&&n.controller.deactivate(),b.push(o),2===o.controller.activate.length?o.controller.activate(e,(function(){r(h,a.transitionDelay)})):(o.controller.activate(e),r(h,a.transitionDelay))}function A(t,e){var n,i,o,s,u=y.name(),d=function(){N("out",n),N("in",i),f((function(){!function(t,e){t.pop(),p.transition.end&&e||P({target:t.element,propertyName:"no-transition"})}(n,u),function(t,e){t.unStack("unstack").bringIn(),p.transition.end&&e||P({target:t.element,propertyName:"no-transition"})}(i,u)}))};if(n=b[b.length-1],e){if(-1===(o=function(t){var e,n;for(e=0,n=b.lenth;e<n&&b[e].id!==t;e+=1);return e===n?-1:e}(e)))throw y.clear(),new Error("View "+e+" is not on stack");if(o===b.length-1)throw y.clear(),new Error("Cannot pop to the current view: "+e);i=b[o],s=o+1}else i=b[b.length-2];i.stack(),c.addClass(l,"view-transitioning"),i.show(!0),y.from(n).to(i),t.fromView=n.id,t.viewAction="pop",n.controller.deactivate(),e?b.splice(s,b.length-s):b.pop(),2===i.controller.activate.length?i.controller.activate(t,(function(){r(d,a.transitionDelay)})):(i.controller.activate(t),r(d,a.transitionDelay))}function S(t,e,n){c.dispatchEvent("viewload"+t,{element:l,data:{viewId:e,error:n}})}function N(t,e){c.dispatchEvent("beforeviewtransition"+t,{element:l,cancelable:!0,data:{viewId:e.id}}),c.dispatchEvent("beforetransition"+t,{element:e.element})}function P(t){var e,n,r,i,o=t.target.getAttribute("data-view");o&&(e=u[o],y.transitionEnded(e)&&(e.isIn()?(e.wasUnStacked()&&e.reset("unstack"),n="in"):e.wasPopped()?(e.reset(["showing","pop"]),n="out"):e.isStacked()&&(e.show(!1),n="out"),function(t,e){c.dispatchEvent("viewtransition"+t,{element:l,data:{viewId:e.id}}),c.dispatchEvent("transition"+t,{element:e.element})}(n,e),y.inProgress()||(y.clear(),c.removeClass(l,"view-transitioning"),(r=y.name())!==(i=b[b.length-1]).transition&&(c.removeClass(l,r).addClass(l,i.transition),y.name(i.transition)))))}V&&(c.addClass(l,V),y.name(V)),t.addEventListener("unload",(function(){for(var t in u){var e=u[t];e&&e.controller&&e.controller.destroy()}}));var I,x,O=(x=o={getViewPort:function(){return l},pushView:function(t,e){var n=u[t],r=s.shallowCopy({},e);y.inProgress()?console.log("pushView() View transitioin in progress. Ignoring this call"):(y.inProgress(!0),n?k(t,r):this.loadView(t,(function(e){e.error?(y.clear(),console.error("Error loading view",e)):k(t,r)})))},popView:function(t){var e=s.shallowCopy({},t),n=e.toView;if(y.inProgress())console.debug("popView() View transitioin in progress. Ignoring this call");else{if(b.length<2)throw new Error("Can't pop. One or less view(s)");y.inProgress(!0),A(e,n)}},currentView:function(){var t=b[b.length-1];return t?t.id:null},previousView:function(){var t;return b.length>=2&&(t=b[b.length-2])?t.id:null},indexOfView:function(t){var e=-1;return b.some((function(n,r){return n.id===t&&(e=r,!0)})),e},isTransitionInProgress:function(){return y.inProgress()},loadView:function(t,e){var r,i=d[t],o=function(n){e({viewId:t,error:n.error,path:n.path}),S("end",t,n.error)};if(i)i.factory?e({viewId:t}):(S("start",t),r=i.path,h.test(r)?function(t,e,r){var i=t.id,o=t.path,a=n.createElement("div");a.className="view-holder",a.setAttribute("data-view-id",i),a.setAttribute("data-view-template",o),m(o,a=e.appendChild(a),(function(t){r({path:t.src,element:a,error:t.error})}))}(i,l,o):w(i,l,o));else{var a=new Error("View not defined: "+t);e({viewId:t,error:a})}},getViewController:function(t){return u[t].controller}},{getViewPort:function(){return x.getViewPort()},pushView:function(t,e){return x.pushView(t,e)},popView:function(t){return x.popView(t)},currentView:function(){return x.currentView()},previousView:function(){return x.previousView()}}),T=a.contextFactory;return"function"==typeof T&&(I=T(o,e)),i=I?s.shallowCopy({},O,I):O,o}return C.prototype={constructor:C,show:function(t){return!1===t?c.removeClass(this.element,"showing"):c.addClass(this.element,"showing"),this},bringIn:function(){c.addClass(this.element,"in")},isIn:function(){return c.hasClass(this.element,"in")},stack:function(){return c.hasClass(this.element,"stack")||c.removeClass(this.element,"in").addClass(this.element,"stack"),this},isStacked:function(){return c.hasClass(this.element,"stack")},unStack:function(t){return c.removeClass(this.element,"stack"),t&&c.addClass(this.element,"unstack"),this},wasUnStacked:function(){return c.hasClass(this.element,"unstack")},pop:function(){return c.removeClass(this.element,"in").addClass(this.element,"pop"),this},wasPopped:function(){return c.hasClass(this.element,"pop")},reset:function(t){if("string"==typeof t)c.removeClass(this.element,t);else{var e=this;t.forEach((function(t){c.removeClass(e.element,t)}))}}},E.prototype={constructor:E,initialize:function(){},activate:function(){},update:function(){},deactivate:function(){},destroy:function(){}},b.defineView=function(t,e){var n,r=t;"object"==typeof r&&(t=r.id,e=r.factory,n=r.template);var i=y(t);i.factory=e,i.template=n},b.views=function(t){for(var e in t)s.ownsProperty(t,e)&&(y(e).path=t[e])},b.view=function(t,e){y(t).path=e},b}()}(t);"function"==typeof define&&define.amd?define((function(){return n})):"object"==typeof module&&module.exports?module.exports=n:t.Stage=n}("undefined"==typeof window?this:window);