!function(t,e){var n=e(t);"function"==typeof define&&define.amd?define(function(){return n}):"object"==typeof module&&module.exports?module.exports=n:t.Stage=n}("undefined"==typeof window?this:window,function(t,e){var n=t.document,r=t.setTimeout,i=(t.setInterval,t.XMLHttpRequest),o=t.getComputedStyle,a=t.requestAnimationFrame,s=function(){var t=Array.prototype,e=Object.prototype,n=t.slice,r=n,i=e.toString;return{shallowCopy:function(){for(var t,e=arguments[0],n=Array.prototype.slice.call(arguments,1),r=0,i=n.length;r<i;r++){t=n[r];for(var o in t)e[o]=t[o]}return e},ownsProperty:function(t,e){if(t.hasOwnProperty)return t.hasOwnProperty(e);var n=t[e];return"undefined"!=typeof n&&t.constructor.prototype[e]!==n},slice:function(t,e,n){var o,a,s=t.length,l=e||0,c=n||s;if("[object Array]"===i.call(t))o=r.call(t,l,c);else for(c<0&&(c=s-c),o=[],a=l;a<c;a++)o[o.length]=t[a];return o},trim:function(t){return t.replace(/^\s+|\s+$/g,"")}}}(),l=function(){function e(t,e,n){var r,i=v.cloneNode();return e+="",i.innerHTML=["<",t,">",e,"</",t,">"].join(""),r=n?i.firstChild.firstChild.childNodes:i.firstChild.childNodes}function r(t){return u[t]||(u[t]=new RegExp("(^|\\s+)"+t+"(?:\\s+|$)"))}function i(t,e){var n=t.classList;return!(!n||!e)&&(n.add(e),!0)}function a(t,e){var n=t.classList;return!(!n||!e)&&(n.remove(e),!0)}function l(t,e){return r(e).test(t.className)}function c(t,e,r){var i=n.createEvent("Event");return i.initEvent(t,r.bubbles,r.cancelable),i.srcElement=e,i}var u={},d=!!t.ActiveXObject,f=/^\s*<(!--\s*.*)?(\w+)[^>]*>/,v=n.createElement("div"),p=n.createElement("table"),h=n.createElement("tr"),m={"*":v,tbody:p,tfoot:p,tr:n.createElement("tbody"),td:h,th:h},w=typeof("function"===t.Event);return{selectOne:function(t,e){return"string"==typeof t?(e||n).querySelector(t):t},select:function(t,e){return"string"==typeof t?(e||n).querySelectorAll(t):t},asFragment:function(t,r){var i,o,a,l,c;r||(o=f.exec(t),r=o?o[2]:null),i=(m[r]||v).cloneNode(),d?(l=i.tagName.toLowerCase(),"tbody"===l||"table"===l||"thead"===l||"tfoot"===l?a=e("table",t,!0):(i.innerHTML=""+t,a=i.childNodes)):(i.innerHTML=""+t,a=i.childNodes),a=s.slice(a),c=n.createDocumentFragment();for(var u=0,p=a.length;u<p;u+=1)c.appendChild(a[u]);return c},dispatchEvent:function(t,e){var r,i=e.element||n,o=e.data;if(w)try{r=new Event(t,{bubbles:e.bubbles||!1,cancelable:e.cancelable||!1})}catch(a){r=c(t,i,e)}else r=c(t,i,e);for(var l in o)s.ownsProperty(o,l)&&(r[l]=o[l]);i.dispatchEvent(r)},hasClass:l,addClass:function(t,e){var n;if(t.length)for(var r=0,o=t.length;r<o;r+=1)n=t[r],l(n,e)||i(n,e)||(n.className+=" "+e);else n=t,l(n,e)||i(n,e)||(n.className+=" "+e);return this},removeClass:function(t,e){var n;if(t.length)for(var i=0,o=t.length;i<o;i+=1)n=t[i],l(n,e)&&!a(n,e)&&(n.className=s.trim(n.className.replace(r(e),"$1")));else n=t,l(n,e)&&!a(n,e)&&(n.className=s.trim(n.className.replace(r(e),"$1")));return this},getComputedStyle:function(t){return o?o(t):t.currentStyle},data:function(t){var e=arguments[1],n=arguments[2],r=t.__stagedata__;return r||(r=t.__stagedata__={}),2===arguments.length?r[e]:(3===arguments.length&&(r[e]=n),this)}}}(),c=function(){function e(t){var e=new i,n=!1,r=t.path,o=t.method||"GET",a=t.success,s=t.fail,l="undefined"==typeof t.timeout?3e4:t.timeout;e.open(o,r,!0),e.timeout=l,e.addEventListener("readystatechange",function(){var t,r=e.readyState;2!==r&&3!==r||(n=!0),4===r&&(t=e.status,t>=200&&t<400||0===t&&n?a&&a(e):s&&s(t,e))}),e.addEventListener("timeout",function(){s&&s("timeout",e)}),e.send()}function o(t,e,r){var i=n.createElement("script");i.textContent=r?"(function() {\n"+t+"\n})();":t,e.appendChild(i)}function c(t,e,r){var i=n.createElement("script");"onreadystatechange"in i?i.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||r(t)}:i.onload=function(){r(t)},i.src=t,i.async=1,e.appendChild(i)}function u(t,r,i){e({path:t,method:"GET",success:function(e){var a=n.createElement("div"),u=l.asFragment(e.responseText),d=s.slice(l.select("script",u)).filter(function(t){var e=t.getAttribute("type")||"text/javascript";return e.indexOf("/javascript")!==-1}),f=function(){var e,n;d.length?(e=d.shift(),(n=e.getAttribute("src"))?c(n,a,f):(o(e.textContent,a),f())):i({path:t,error:!1,element:a})};d.forEach(function(t){t.parentNode.removeChild(t)}),a.className="view-holder",a.setAttribute("data-view-template",t),a.appendChild(u),r.appendChild(a),f()},fail:function(e,n){i({path:t,error:e||!0,xhr:n})}})}function d(t){var e=m[t];return e||(e=m[t]={id:t}),e}function f(t,e,n){this.id=t,this.element=e,this.controller=n}function v(){function t(t){var e=l.getComputedStyle(t),n=e["transition-property"]||e["-webkit-transition-property"]||e["-moz-transitionProperty"];return n?n.split(",").length:0}var e,n,r,i=!1;return eventCount={},{name:function(){return arguments.length?(e=arguments[0],this):e},from:function(e){return n=e.id,eventCount[e.id]=t(e.element),this},to:function(e){return r=e.id,eventCount[e.id]=t(e.element),this},transitionEnded:function(t){var e;return eventCount[t.id]-=1,e=!eventCount[t.id],i=eventCount[n]||eventCount[r],e},inProgress:function(){return arguments.length?(i=arguments[0],this):i},clear:function(){delete eventCount[n],delete eventCount[r],i=!1,n=r=null}}}function p(t){var e=t;return{getViewPort:function(){return e.getViewPort()},pushView:function(t,n){return e.pushView(t,n)},popView:function(t){return e.popView(t)},currentView:function(){return e.currentView()},previousView:function(){return e.previousView()}}}function h(t){function e(t){var e,n,r='[data-view="'+t+'"]',i=l.selectOne(r,I),o=m[t];if(!i)throw new Error("UI for view "+t+" not found.");return i.addEventListener(C.transition.end||"transitionend",P),i.addEventListener(C.animation.end||"animationend",P),e=o.factory(S,i),w.forEach(function(t){"undefined"==typeof e[t]&&(e[t]=g)}),n=T[t]=new f(t,i,e)}function n(t,n){var i,o=T[t],s="transition"in n?n.transition:O,u=function(){i&&k("out",i),k("in",o),y(function(){i&&c(i,s),a(o,s)})},d=x.name();if(d!==s&&(x.name(s),d&&l.removeClass(I,d),l.addClass(I,s)),i=L.length?L[L.length-1]:null){if(i.id===t)return i.controller.update(n),void x.clear();x.from(i),n.fromView=i.id}l.addClass(I,"view-transitioning"),o?o.unStack().show(!0):(o=e(t,n),o.show(!0),o.controller.initialize(n)),o.transition=s,x.to(o),i&&i.controller.deactivate();var f=o.controller.activate;2===f.length?o.controller.activate(n,function(){r(u,A.transitionDelay)}):(o.controller.activate(n),r(u,A.transitionDelay)),L.push(o)}function i(t,e){var n,i,a,s=x.name(),c=function(){k("out",n),k("in",i),y(function(){d(n,s),h(i,s)})};if(n=L.pop(),e){if(a=o(e),a===-1)throw L.push(n),x.clear(),new Error("View "+e+" is not on stack");i=L[a],L.splice(a+1,L.length-(a+1))}else i=L[L.length-1];i.stack(),l.addClass(I,"view-transitioning"),i.show(!0),x.from(n).to(i),n.controller.deactivate();var u=i.controller.activate;2===u.length?i.controller.activate(t,function(){r(c,A.transitionDelay)}):(i.controller.activate(t),r(c,A.transitionDelay))}function o(t){var e,n;for(e=0,n=L.lenth;e<n&&L[e].id!==t;e+=1);return e===n?-1:e}function a(t,e){t.bringIn(),C.transition.end&&e||P({target:t.element,propertyName:b})}function c(t,e){t.stack(),C.transition.end&&e||P({target:t.element,propertyName:b})}function d(t,e){t.pop(),C.transition.end&&e||P({target:t.element,propertyName:b})}function h(t,e){t.unStack("unstack").bringIn(),C.transition.end&&e||P({target:t.element,propertyName:b})}function V(t,e){l.dispatchEvent("viewtransition"+t,{element:I,data:{viewId:e.id}}),l.dispatchEvent("transition"+t,{element:e.element})}function k(t,e){l.dispatchEvent("beforeviewtransition"+t,{element:I,cancelable:!0,data:{viewId:e.id}}),l.dispatchEvent("beforetransition"+t,{element:e.element})}function P(t){var e,n,r,i,o=t.target,a=o.getAttribute("data-view");a&&(e=T[a],x.transitionEnded(e)&&(e.isIn()?(e.wasUnStacked()&&e.reset("unstack"),n="in"):e.wasPopped()?(e.reset(["showing","pop"]),n="out"):e.isStacked()&&(e.show(!1),n="out"),V(n,e),x.inProgress()||(x.clear(),l.removeClass(I,"view-transitioning"),r=x.name(),i=L[L.length-1],r!==i.transition&&(l.removeClass(I,r).addClass(I,i.transition),x.name(i.transition)))))}var S,N,A=s.shallowCopy({},E,t),I=l.selectOne(A.viewport),T={},x=v(),L=[];if(console.debug("Stage options ",A),!I||1!==I.nodeType)throw new Error("Use a valid element as view port");var O=A.transition;return O&&(l.addClass(I,O),x.name(O)),N={getViewPort:function(){return I},pushView:function(t,e){var r=this,i=T[t],o=s.shallowCopy({},e);return x.inProgress()?void console.log("pushView() View transitioin in progress. Ignoring this call"):(x.inProgress(!0),void(i?n(t,o):r.loadView(t,function(e){if(e.error)throw x.clear(),new Error("Error loading view: "+e.error);n(t,o)})))},popView:function(t){var e=s.shallowCopy({},t),n=e.toView;if(x.inProgress())return void console.debug("popView() View transitioin in progress. Ignoring this call");if(L.length<2)throw new Error("Can't pop. One or less view(s)");x.inProgress(!0),i(e,n)},currentView:function(){var t=L[L.length-1];return t?t.id:null},previousView:function(){var t;return L.length>=2?(t=L[L.length-2],t?t.id:null):null},indexOfView:function(t){var e=-1;return L.some(function(n,r){return n.id===t&&(e=r,!0)}),e},isTransitionInProgress:function(){return x.inProgress()},loadView:function(t,e){var n=m[t];if(!n)throw new Error("Don't know of view: "+t);n.factory?e({viewId:t,error:!1}):u(n.templatePath,I,function(n){e({viewId:t,error:n.error})})},getViewController:function(t){return T[t].controller}},S=p(N),N}var m={},w=["initialize","activate","update","deactivate","destroy"],g=function(){},y=a||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(t){return r(t,1e3/60)},C=function(){var t=["","Webkit","Moz","O","ms","MS"],e=["transitionend","webkitTransitionEnd","transitionend","oTransitionEnd","MSTransitionEnd"],r=["animationend","webkitAnimationEnd","animationend","oAnimationEnd","animationend"],i=n.createElement("div"),o=i.style;return{transition:function(){for(var n,r,i=0,a=t.length;i<a;i+=1)if(n=t[i],r=n?n+"Transition":"transition","undefined"!=typeof o[r])return{property:r,end:e[i]};return{}}(),animation:function(){for(var e,n,i=0,a=t.length;i<a;i+=1)if(e=t[i],n=e?e+"Animation":"animation","undefined"!=typeof o[n])return{property:n,end:r[i]};return{}}()}}(),E={transitionDelay:150,transition:"slide"},b="no-transition";return f.prototype={constructor:f,show:function(t){return t===!1?l.removeClass(this.element,"showing"):l.addClass(this.element,"showing"),this},bringIn:function(){l.addClass(this.element,"in")},isIn:function(){return l.hasClass(this.element,"in")},stack:function(){return l.hasClass(this.element,"stack")||l.removeClass(this.element,"in").addClass(this.element,"stack"),this},isStacked:function(){return l.hasClass(this.element,"stack")},unStack:function(t){return l.removeClass(this.element,"stack"),t&&l.addClass(this.element,"unstack"),this},wasUnStacked:function(){return l.hasClass(this.element,"unstack")},pop:function(){return l.removeClass(this.element,"in").addClass(this.element,"pop"),this},wasPopped:function(){return l.hasClass(this.element,"pop")},reset:function(t){if("string"==typeof t)l.removeClass(this.element,t);else{var e=this;t.forEach(function(t){l.removeClass(e.element,t)})}}},h.defineView=function(t,e){var n=d(t,e);n.factory=e},h.views=function(t){var e;for(var n in t)s.ownsProperty(t,n)&&(e=d(n),e.templatePath=t[n])},h.view=function(t,e){var n=d(t);n.templatePath=e},h}();return c});