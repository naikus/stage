!function(t,e){var n=e(t);"function"==typeof define&&define.amd?define(function(){return n}):"object"==typeof module&&module.exports?module.exports=n:t.Stage=n}("undefined"==typeof window?this:window,function(t,e){var n=t.document,r=t.setTimeout,i=(t.setInterval,t.XMLHttpRequest),o=t.getComputedStyle,a=t.requestAnimationFrame,s=function(){var t=function(){},e=Object.create||function(t){function e(){}return e.prototype=t,new e},n=Array.prototype,r=Object.prototype,i=n.slice,o=i,a=r.toString;return{extend:function(n,r){function i(){n.apply&&n.apply(this,arguments),o.apply(this,arguments)}var o=r._constructor||t;delete r._constructor;var a=i.prototype=e(n.prototype);for(var s in r)r.hasOwnProperty(s)&&(a[s]=r[s]);return a.constructor=i,i},shallowCopy:function(){for(var t,e=arguments[0],n=Array.prototype.slice.call(arguments,1),r=0,i=n.length;i>r;r++){t=n[r];for(var o in t)e[o]=t[o]}return e},ownsProperty:function(t,e){if(t.hasOwnProperty)return t.hasOwnProperty(e);var n=t[e];return"undefined"!=typeof n&&t.constructor.prototype[e]!==n},slice:function(t,e,n){var r,i,s=t.length,c=e||0,u=n||s;if("[object Array]"===a.call(t))r=o.call(t,c,u);else for(0>u&&(u=s-u),r=[],i=c;u>i;i++)r[r.length]=t[i];return r},trim:function(t){return t.replace(/^\s+|\s+$/g,"")}}}(),c=function(){function e(t,e,n){var r,i=p.cloneNode();return e+="",i.innerHTML=["<",t,">",e,"</",t,">"].join(""),r=n?i.firstChild.firstChild.childNodes:i.firstChild.childNodes}function r(t){return l[t]||(l[t]=new RegExp("(^|\\s+)"+t+"(?:\\s+|$)"))}function i(t,e){var n=t.classList;return n&&e?(n.add(e),!0):!1}function a(t,e){var n=t.classList;return n&&e?(n.remove(e),!0):!1}function c(t,e){return r(e).test(t.className)}function u(t,e,r){var i=n.createEvent("Event");return i.initEvent(t,r.bubbles,r.cancelable),i.srcElement=e,i}var l={},d=!!t.ActiveXObject,f=/^\s*<(!--\s*.*)?(\w+)[^>]*>/,p=n.createElement("div"),v=n.createElement("table"),h=n.createElement("tr"),m={"*":p,tbody:v,tfoot:v,tr:n.createElement("tbody"),td:h,th:h},w=typeof("function"===t.Event);return{selectOne:function(t,e){return"string"==typeof t?(e||n).querySelector(t):t},select:function(t,e){return"string"==typeof t?(e||n).querySelectorAll(t):t},asFragment:function(t,r){var i,o,a,c,u;r||(o=f.exec(t),r=o?o[2]:null),i=(m[r]||p).cloneNode(),d?(c=i.tagName.toLowerCase(),"tbody"===c||"table"===c||"thead"===c||"tfoot"===c?a=e("table",t,!0):(i.innerHTML=""+t,a=i.childNodes)):(i.innerHTML=""+t,a=i.childNodes),a=s.slice(a),u=n.createDocumentFragment();for(var l=0,v=a.length;v>l;l+=1)u.appendChild(a[l]);return u},dispatchEvent:function(t,e){var r,i=e.element||n,o=e.data;if(w)try{r=new Event(t,{bubbles:e.bubbles||!1,cancelable:e.cancelable||!1})}catch(a){r=u(t,i,e)}else r=u(t,i,e);for(var s in o)r[s]=o[s];i.dispatchEvent(r)},hasClass:c,addClass:function(t,e){var n;if(t.length)for(var r=0,o=t.length;o>r;r+=1)n=t[r],c(n,e)||i(n,e)||(n.className+=" "+e);else n=t,c(n,e)||i(n,e)||(n.className+=" "+e);return this},removeClass:function(t,e){var n;if(t.length)for(var i=0,o=t.length;o>i;i+=1)n=t[i],c(n,e)&&!a(n,e)&&(n.className=s.trim(n.className.replace(r(e),"$1")));else n=t,c(n,e)&&!a(n,e)&&(n.className=s.trim(n.className.replace(r(e),"$1")));return this},getComputedStyle:function(t){return o?o(t):t.currentStyle},data:function(t){var e=arguments[1],n=arguments[2],r=t.__stagedata__;return r||(r=t.__stagedata__={}),2===arguments.length?r[e]:(3===arguments.length&&(r[e]=n),this)}}}(),u=function(){function e(t){var e=new i,n=!1,r=t.path,o=t.method||"GET",a=t.success,s=t.fail,c="undefined"==typeof t.timeout?3e4:t.timeout;e.open(o,r,!0),e.timeout=c,e.addEventListener("readystatechange",function(){var t,r=e.readyState;(2===r||3===r)&&(n=!0),4===r&&(t=e.status,t>=200&&400>t||0===t&&n?a&&a(e):s&&s(t,e))}),e.addEventListener("timeout",function(){s&&s("timeout",e)}),e.send()}function o(t,e,r){var i=n.createElement("script");i.textContent=r?"(function() {\n"+t+"\n})();":t,e.appendChild(i)}function u(t,e,r){var i=n.createElement("script");i.onerror=function(){r({error:!0,src:t})},"onreadystatechange"in i?i.onreadystatechange=function(){("loaded"===this.readyState||"complete"===this.readyState)&&r({src:t})}:i.onload=function(){r({src:t})},i.src=t,i.async=1,e.appendChild(i)}function l(t,r,i){var a=t.path;e({path:a,method:"GET",success:function(t){var e=n.createElement("div"),l=c.asFragment(t.responseText),d=s.slice(c.select("script",l)).filter(function(t){var e=t.getAttribute("type")||"text/javascript";return-1!==e.indexOf("/javascript")}),f=function(t){t&&t.error&&console.error("Error loading script",t.src,t.error);var n,r;d.length?(n=d.shift(),(r=n.getAttribute("src"))?u(r,e,f):(o(n.textContent,e),f())):i({path:a,error:!1,element:e})};d.forEach(function(t){t.parentNode.removeChild(t)}),e.className="view-holder",e.setAttribute("data-view-template",a),e.appendChild(l),r.appendChild(e),f()},fail:function(t,e){i({path:a,error:t||!0,xhr:e})}})}function d(t,e,r){var i=(t.id,t.path),o=(t.template||k,n.createElement("div"));o.className="view-holder",o.setAttribute("data-view-template",i),o=e.appendChild(o),u(i,o,function(t){r({path:t.src,element:o,error:t.error})})}function f(t,e){var n=c.asFragment(t),r=n.firstChild;return c.addClass(r,"stage-view"),r.setAttribute("data-view",e),r}function p(t,e){var n,r,i=t.id,o='[data-view="'+i+'"]',a='[data-view-template="'+t.path+'"]';return r=c.selectOne(o,e),r?r:(r=f(t.template||k,i),n=c.selectOne(a,e),r=n?n.insertBefore(r,n.firstChild):e.appendChild(r))}function v(t){var e=C[t];return e||(e=C[t]={id:t}),e}function h(t,e,n){this.id=t,this.element=e,this.controller=n}function m(){}function w(){function t(t){var e=c.getComputedStyle(t),n=e["transition-property"]||e["-webkit-transition-property"]||e["-moz-transitionProperty"];return n?n.split(",").length:0}var e,n,r,i=!1;return eventCount={},{name:function(){return arguments.length?(e=arguments[0],this):e},from:function(e){return n=e.id,eventCount[e.id]=t(e.element),this},to:function(e){return r=e.id,eventCount[e.id]=t(e.element),this},transitionEnded:function(t){var e;return eventCount[t.id]-=1,e=!eventCount[t.id],i=eventCount[n]||eventCount[r],e},inProgress:function(){return arguments.length?(i=arguments[0],this):i},clear:function(){delete eventCount[n],delete eventCount[r],i=!1,n=r=null}}}function g(t,e){var n=t;return{getViewPort:function(){return n.getViewPort()},pushView:function(t,e){return n.pushView(t,e)},popView:function(t){return n.popView(t)},currentView:function(){return n.currentView()},previousView:function(){return n.previousView()},context:function(){return e}}}function y(t){function e(t){var e,n,r,i=C[t],o=p(i,j);if(!o)throw new Error("UI for view "+t+" not found.");return o.addEventListener(b.transition.end||"transitionend",I,!1),o.addEventListener(b.animation.end||"animationend",I,!1),e=s.extend(m,i.factory(O,o)),n=new e,r=_[t]=new h(t,o,n)}function n(t,n){var i,o=_[t],s="transition"in n?n.transition:D,l=function(){i&&x("out",i),x("in",o),E(function(){i&&u(i,s),a(o,s)})};n.viewAction=A;var d=F.name();if(d!==s&&(F.name(s),d&&c.removeClass(j,d),c.addClass(j,s)),i=q.length?q[q.length-1]:null){if(i.id===t)return i.controller.update(n),void F.clear();F.from(i),n.fromView=i.id}c.addClass(j,"view-transitioning"),o?o.unStack().show(!0):(o=e(t,n),o.show(!0),o.controller.initialize(n)),o.transition=s,F.to(o),i&&i.controller.deactivate(),q.push(o);var f=o.controller.activate;2===f.length?o.controller.activate(n,function(){r(l,L.transitionDelay)}):(o.controller.activate(n),r(l,L.transitionDelay))}function i(t,e){var n,i,a,s,u=F.name(),l=function(){x("out",n),x("in",i),E(function(){f(n,u),v(i,u)})};if(n=q[q.length-1],e){if(a=o(e),-1===a)throw F.clear(),new Error("View "+e+" is not on stack");if(a===q.length-1)throw F.clear(),new Error("Cannot pop to the current view: "+e);i=q[a],s=a+1}else i=q[q.length-2];i.stack(),c.addClass(j,"view-transitioning"),i.show(!0),F.from(n).to(i),t.fromView=n.id,t.viewAction=P,n.controller.deactivate(),e?q.splice(s,q.length-s):q.pop();var d=i.controller.activate;2===d.length?i.controller.activate(t,function(){r(l,L.transitionDelay)}):(i.controller.activate(t),r(l,L.transitionDelay))}function o(t){var e,n;for(e=0,n=q.lenth;n>e&&q[e].id!==t;e+=1);return e===n?-1:e}function a(t,e){t.bringIn(),b.transition.end&&e||I({target:t.element,propertyName:N})}function u(t,e){t.stack(),b.transition.end&&e||I({target:t.element,propertyName:N})}function f(t,e){t.pop(),b.transition.end&&e||I({target:t.element,propertyName:N})}function v(t,e){t.unStack("unstack").bringIn(),b.transition.end&&e||I({target:t.element,propertyName:N})}function y(t,e,n){c.dispatchEvent("viewload"+t,{element:j,data:{viewId:e,error:n}})}function k(t,e){c.dispatchEvent("viewtransition"+t,{element:j,data:{viewId:e.id}}),c.dispatchEvent("transition"+t,{element:e.element})}function x(t,e){c.dispatchEvent("beforeviewtransition"+t,{element:j,cancelable:!0,data:{viewId:e.id}}),c.dispatchEvent("beforetransition"+t,{element:e.element})}function I(t){var e,n,r,i,o=t.target,a=o.getAttribute("data-view");a&&(e=_[a],F.transitionEnded(e)&&(e.isIn()?(e.wasUnStacked()&&e.reset("unstack"),n="in"):e.wasPopped()?(e.reset(["showing","pop"]),n="out"):e.isStacked()&&(e.show(!1),n="out"),k(n,e),F.inProgress()||(F.clear(),c.removeClass(j,"view-transitioning"),r=F.name(),i=q[q.length-1],r!==i.transition&&(c.removeClass(j,r).addClass(j,i.transition),F.name(i.transition)))))}var O,T,L=s.shallowCopy({},V,t),j=c.selectOne(L.viewport),_={},F=w(),q=[];if(console.debug("Stage options ",L),!j||1!==j.nodeType)throw new Error("Use a valid element as view port");var D=L.transition;return D&&(c.addClass(j,D),F.name(D)),T={getViewPort:function(){return j},pushView:function(t,e){var r=this,i=_[t],o=s.shallowCopy({},e);return F.inProgress()?void console.log("pushView() View transitioin in progress. Ignoring this call"):(F.inProgress(!0),void(i?n(t,o):r.loadView(t,function(e){e.error?(F.clear(),console.error("Error loading view",e)):n(t,o)})))},popView:function(t){var e=s.shallowCopy({},t),n=e.toView;if(F.inProgress())return void console.debug("popView() View transitioin in progress. Ignoring this call");if(q.length<2)throw new Error("Can't pop. One or less view(s)");F.inProgress(!0),i(e,n)},currentView:function(){var t=q[q.length-1];return t?t.id:null},previousView:function(){var t;return q.length>=2?(t=q[q.length-2],t?t.id:null):null},indexOfView:function(t){var e=-1;return q.some(function(n,r){return n.id===t?(e=r,!0):!1}),e},isTransitionInProgress:function(){return F.inProgress()},loadView:function(t,e){var n,r=C[t],i=function(n){e({viewId:t,error:n.error,path:n.path}),y("end",t,n.error)};if(!r)throw new Error("Don't know of view: "+t);r.factory?e({viewId:t}):(y("start",t),n=r.path,S.test(n)?d(r,j,i):l(r,j,i))},getViewController:function(t){return _[t].controller}},O=g(T,L.context||{}),T}var C={},E=a||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(t){return r(t,1e3/60)},b=function(){var t=["","Webkit","Moz","O","ms","MS"],e=["transitionend","webkitTransitionEnd","transitionend","oTransitionEnd","MSTransitionEnd"],r=["animationend","webkitAnimationEnd","animationend","oAnimationEnd","animationend"],i=n.createElement("div"),o=i.style;return{transition:function(){for(var n,r,i=0,a=t.length;a>i;i+=1)if(n=t[i],r=n?n+"Transition":"transition","undefined"!=typeof o[r])return{property:r,end:e[i]};return{}}(),animation:function(){for(var e,n,i=0,a=t.length;a>i;i+=1)if(e=t[i],n=e?e+"Animation":"animation","undefined"!=typeof o[n])return{property:n,end:r[i]};return{}}()}}(),V={transitionDelay:100,transition:"slide"},k='<div class="stage-view"></div>',N="no-transition",S=/\.js$/,A="push",P="pop";return h.prototype={constructor:h,show:function(t){return t===!1?c.removeClass(this.element,"showing"):c.addClass(this.element,"showing"),this},bringIn:function(){c.addClass(this.element,"in")},isIn:function(){return c.hasClass(this.element,"in")},stack:function(){return c.hasClass(this.element,"stack")||c.removeClass(this.element,"in").addClass(this.element,"stack"),this},isStacked:function(){return c.hasClass(this.element,"stack")},unStack:function(t){return c.removeClass(this.element,"stack"),t&&c.addClass(this.element,"unstack"),this},wasUnStacked:function(){return c.hasClass(this.element,"unstack")},pop:function(){return c.removeClass(this.element,"in").addClass(this.element,"pop"),this},wasPopped:function(){return c.hasClass(this.element,"pop")},reset:function(t){if("string"==typeof t)c.removeClass(this.element,t);else{var e=this;t.forEach(function(t){c.removeClass(e.element,t)})}}},m.prototype={constructor:m,initialize:function(){},activate:function(){},update:function(){},deactivate:function(){},destroy:function(){}},y.defineView=function(t,e){var n,r=t;"object"==typeof r&&(t=r.id,e=r.factory,n=r.template);var i=v(t,e);i.factory=e,i.template=n},y.views=function(t){var e;for(var n in t)s.ownsProperty(t,n)&&(e=v(n),e.path=t[n])},y.view=function(t,e){var n=v(t);n.path=e},y}();return u});