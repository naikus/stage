!function(t,e){var n=e(t);"function"==typeof define&&define.amd?define(function(){return n}):"object"==typeof module&&module.exports?module.exports=n:t.Stage=n}("undefined"==typeof window?this:window,function(t,e){var n=t.document,r=t.setTimeout,i=(t.setInterval,t.XMLHttpRequest),o=t.getComputedStyle,a=t.requestAnimationFrame,s=function(){var t=function(){},e=Object.create||function(t){function e(){}return e.prototype=t,new e},n=Array.prototype,r=Object.prototype,i=n.slice,o=i,a=r.toString;return{extend:function(n,r){function i(){n.apply&&n.apply(this,arguments),o.apply(this,arguments)}var o=r._constructor||t;delete r._constructor;var a=i.prototype=e(n.prototype);for(var s in r)r.hasOwnProperty(s)&&(a[s]=r[s]);return a.constructor=i,i},shallowCopy:function(){for(var t,e=arguments[0],n=Array.prototype.slice.call(arguments,1),r=0,i=n.length;r<i;r++){t=n[r];for(var o in t)e[o]=t[o]}return e},ownsProperty:function(t,e){if(t.hasOwnProperty)return t.hasOwnProperty(e);var n=t[e];return"undefined"!=typeof n&&t.constructor.prototype[e]!==n},slice:function(t,e,n){var r,i,s=t.length,c=e||0,u=n||s;if("[object Array]"===a.call(t))r=o.call(t,c,u);else for(u<0&&(u=s-u),r=[],i=c;i<u;i++)r[r.length]=t[i];return r},trim:function(t){return t.replace(/^\s+|\s+$/g,"")}}}(),c=function(){function e(t,e,n){var r,i=p.cloneNode();return e+="",i.innerHTML=["<",t,">",e,"</",t,">"].join(""),r=n?i.firstChild.firstChild.childNodes:i.firstChild.childNodes}function r(t){return l[t]||(l[t]=new RegExp("(^|\\s+)"+t+"(?:\\s+|$)"))}function i(t,e){var n=t.classList;return!(!n||!e)&&(n.add(e),!0)}function a(t,e){var n=t.classList;return!(!n||!e)&&(n.remove(e),!0)}function c(t,e){return r(e).test(t.className)}function u(t,e,r){var i=n.createEvent("Event");return i.initEvent(t,r.bubbles,r.cancelable),i.srcElement=e,i}var l={},d=!!t.ActiveXObject,f=/^\s*<(!--\s*.*)?(\w+)[^>]*>/,p=n.createElement("div"),v=n.createElement("table"),h=n.createElement("tr"),m={"*":p,tbody:v,tfoot:v,tr:n.createElement("tbody"),td:h,th:h},w=typeof("function"===t.Event);return{selectOne:function(t,e){return"string"==typeof t?(e||n).querySelector(t):t},select:function(t,e){return"string"==typeof t?(e||n).querySelectorAll(t):t},asFragment:function(t,r){var i,o,a,c,u;r||(o=f.exec(t),r=o?o[2]:null),i=(m[r]||p).cloneNode(),d?(c=i.tagName.toLowerCase(),"tbody"===c||"table"===c||"thead"===c||"tfoot"===c?a=e("table",t,!0):(i.innerHTML=""+t,a=i.childNodes)):(i.innerHTML=""+t,a=i.childNodes),a=s.slice(a),u=n.createDocumentFragment();for(var l=0,v=a.length;l<v;l+=1)u.appendChild(a[l]);return u},dispatchEvent:function(t,e){var r,i=e.element||n,o=e.data;if(w)try{r=new Event(t,{bubbles:e.bubbles||!1,cancelable:e.cancelable||!1})}catch(a){r=u(t,i,e)}else r=u(t,i,e);for(var c in o)s.ownsProperty(o,c)&&(r[c]=o[c]);i.dispatchEvent(r)},hasClass:c,addClass:function(t,e){var n;if(t.length)for(var r=0,o=t.length;r<o;r+=1)n=t[r],c(n,e)||i(n,e)||(n.className+=" "+e);else n=t,c(n,e)||i(n,e)||(n.className+=" "+e);return this},removeClass:function(t,e){var n;if(t.length)for(var i=0,o=t.length;i<o;i+=1)n=t[i],c(n,e)&&!a(n,e)&&(n.className=s.trim(n.className.replace(r(e),"$1")));else n=t,c(n,e)&&!a(n,e)&&(n.className=s.trim(n.className.replace(r(e),"$1")));return this},getComputedStyle:function(t){return o?o(t):t.currentStyle},data:function(t){var e=arguments[1],n=arguments[2],r=t.__stagedata__;return r||(r=t.__stagedata__={}),2===arguments.length?r[e]:(3===arguments.length&&(r[e]=n),this)}}}(),u=function(){function e(t){var e=new i,n=!1,r=t.path,o=t.method||"GET",a=t.success,s=t.fail,c="undefined"==typeof t.timeout?3e4:t.timeout;e.open(o,r,!0),e.timeout=c,e.addEventListener("readystatechange",function(){var t,r=e.readyState;2!==r&&3!==r||(n=!0),4===r&&(t=e.status,t>=200&&t<400||0===t&&n?a&&a(e):s&&s(t,e))}),e.addEventListener("timeout",function(){s&&s("timeout",e)}),e.send()}function o(t,e,r){var i=n.createElement("script");i.textContent=r?"(function() {\n"+t+"\n})();":t,e.appendChild(i)}function u(t,e,r){var i=n.createElement("script");"onreadystatechange"in i?i.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||r(t)}:i.onload=function(){r(t)},i.src=t,i.async=1,e.appendChild(i)}function l(t,r,i){e({path:t,method:"GET",success:function(e){var a=n.createElement("div"),l=c.asFragment(e.responseText),d=s.slice(c.select("script",l)).filter(function(t){var e=t.getAttribute("type")||"text/javascript";return e.indexOf("/javascript")!==-1}),f=function(){var e,n;d.length?(e=d.shift(),(n=e.getAttribute("src"))?u(n,a,f):(o(e.textContent,a),f())):i({path:t,error:!1,element:a})};d.forEach(function(t){t.parentNode.removeChild(t)}),a.className="view-holder",a.setAttribute("data-view-template",t),a.appendChild(l),r.appendChild(a),f()},fail:function(e,n){i({path:t,error:e||!0,xhr:n})}})}function d(t){var e=w[t];return e||(e=w[t]={id:t}),e}function f(t,e,n){this.id=t,this.element=e,this.controller=n}function p(){}function v(){function t(t){var e=c.getComputedStyle(t),n=e["transition-property"]||e["-webkit-transition-property"]||e["-moz-transitionProperty"];return n?n.split(",").length:0}var e,n,r,i=!1;return eventCount={},{name:function(){return arguments.length?(e=arguments[0],this):e},from:function(e){return n=e.id,eventCount[e.id]=t(e.element),this},to:function(e){return r=e.id,eventCount[e.id]=t(e.element),this},transitionEnded:function(t){var e;return eventCount[t.id]-=1,e=!eventCount[t.id],i=eventCount[n]||eventCount[r],e},inProgress:function(){return arguments.length?(i=arguments[0],this):i},clear:function(){delete eventCount[n],delete eventCount[r],i=!1,n=r=null}}}function h(t){var e=t;return{getViewPort:function(){return e.getViewPort()},pushView:function(t,n){return e.pushView(t,n)},popView:function(t){return e.popView(t)},currentView:function(){return e.currentView()},previousView:function(){return e.previousView()}}}function m(t){function e(t){var e,n,r,i='[data-view="'+t+'"]',o=c.selectOne(i,I),a=w[t];if(!o)throw new Error("UI for view "+t+" not found.");return o.addEventListener(y.transition.end||"transitionend",P,!1),o.addEventListener(y.animation.end||"animationend",P,!1),e=s.extend(p,a.factory(S,o)),n=new e,r=x[t]=new f(t,o,n)}function n(t,n){var i,o=x[t],s="transition"in n?n.transition:L,l=function(){i&&k("out",i),k("in",o),g(function(){i&&u(i,s),a(o,s)})},d=O.name();if(d!==s&&(O.name(s),d&&c.removeClass(I,d),c.addClass(I,s)),i=T.length?T[T.length-1]:null){if(i.id===t)return i.controller.update(n),void O.clear();O.from(i),n.fromView=i.id}c.addClass(I,"view-transitioning"),o?o.unStack().show(!0):(o=e(t,n),o.show(!0),o.controller.initialize(n)),o.transition=s,O.to(o),i&&i.controller.deactivate();var f=o.controller.activate;2===f.length?o.controller.activate(n,function(){r(l,A.transitionDelay)}):(o.controller.activate(n),r(l,A.transitionDelay)),T.push(o)}function i(t,e){var n,i,a,s=O.name(),u=function(){k("out",n),k("in",i),g(function(){d(n,s),m(i,s)})};if(n=T.pop(),e){if(a=o(e),a===-1)throw T.push(n),O.clear(),new Error("View "+e+" is not on stack");i=T[a],T.splice(a+1,T.length-(a+1))}else i=T[T.length-1];i.stack(),c.addClass(I,"view-transitioning"),i.show(!0),O.from(n).to(i),n.controller.deactivate();var l=i.controller.activate;2===l.length?i.controller.activate(t,function(){r(u,A.transitionDelay)}):(i.controller.activate(t),r(u,A.transitionDelay))}function o(t){var e,n;for(e=0,n=T.lenth;e<n&&T[e].id!==t;e+=1);return e===n?-1:e}function a(t,e){t.bringIn(),y.transition.end&&e||P({target:t.element,propertyName:E})}function u(t,e){t.stack(),y.transition.end&&e||P({target:t.element,propertyName:E})}function d(t,e){t.pop(),y.transition.end&&e||P({target:t.element,propertyName:E})}function m(t,e){t.unStack("unstack").bringIn(),y.transition.end&&e||P({target:t.element,propertyName:E})}function b(t,e,n){c.dispatchEvent("viewload"+t,{element:I,data:{viewId:e,error:n}})}function V(t,e){c.dispatchEvent("viewtransition"+t,{element:I,data:{viewId:e.id}}),c.dispatchEvent("transition"+t,{element:e.element})}function k(t,e){c.dispatchEvent("beforeviewtransition"+t,{element:I,cancelable:!0,data:{viewId:e.id}}),c.dispatchEvent("beforetransition"+t,{element:e.element})}function P(t){var e,n,r,i,o=t.target,a=o.getAttribute("data-view");a&&(e=x[a],O.transitionEnded(e)&&(e.isIn()?(e.wasUnStacked()&&e.reset("unstack"),n="in"):e.wasPopped()?(e.reset(["showing","pop"]),n="out"):e.isStacked()&&(e.show(!1),n="out"),V(n,e),O.inProgress()||(O.clear(),c.removeClass(I,"view-transitioning"),r=O.name(),i=T[T.length-1],r!==i.transition&&(c.removeClass(I,r).addClass(I,i.transition),O.name(i.transition)))))}var S,N,A=s.shallowCopy({},C,t),I=c.selectOne(A.viewport),x={},O=v(),T=[];if(console.debug("Stage options ",A),!I||1!==I.nodeType)throw new Error("Use a valid element as view port");var L=A.transition;return L&&(c.addClass(I,L),O.name(L)),N={getViewPort:function(){return I},pushView:function(t,e){var r=this,i=x[t],o=s.shallowCopy({},e);return O.inProgress()?void console.log("pushView() View transitioin in progress. Ignoring this call"):(O.inProgress(!0),void(i?n(t,o):r.loadView(t,function(e){if(e.error)throw O.clear(),new Error("Error loading view: "+e.error);n(t,o)})))},popView:function(t){var e=s.shallowCopy({},t),n=e.toView;if(O.inProgress())return void console.debug("popView() View transitioin in progress. Ignoring this call");if(T.length<2)throw new Error("Can't pop. One or less view(s)");O.inProgress(!0),i(e,n)},currentView:function(){var t=T[T.length-1];return t?t.id:null},previousView:function(){var t;return T.length>=2?(t=T[T.length-2],t?t.id:null):null},indexOfView:function(t){var e=-1;return T.some(function(n,r){return n.id===t&&(e=r,!0)}),e},isTransitionInProgress:function(){return O.inProgress()},loadView:function(t,e){var n=w[t];if(!n)throw new Error("Don't know of view: "+t);n.factory?e({viewId:t,error:!1}):(b("start",t),l(n.templatePath,I,function(n){e({viewId:t,error:n.error}),b("end",t,n.error)}))},getViewController:function(t){return x[t].controller}},S=h(N),N}var w={},g=a||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(t){return r(t,1e3/60)},y=function(){var t=["","Webkit","Moz","O","ms","MS"],e=["transitionend","webkitTransitionEnd","transitionend","oTransitionEnd","MSTransitionEnd"],r=["animationend","webkitAnimationEnd","animationend","oAnimationEnd","animationend"],i=n.createElement("div"),o=i.style;return{transition:function(){for(var n,r,i=0,a=t.length;i<a;i+=1)if(n=t[i],r=n?n+"Transition":"transition","undefined"!=typeof o[r])return{property:r,end:e[i]};return{}}(),animation:function(){for(var e,n,i=0,a=t.length;i<a;i+=1)if(e=t[i],n=e?e+"Animation":"animation","undefined"!=typeof o[n])return{property:n,end:r[i]};return{}}()}}(),C={transitionDelay:100,transition:"slide"},E="no-transition";return f.prototype={constructor:f,show:function(t){return t===!1?c.removeClass(this.element,"showing"):c.addClass(this.element,"showing"),this},bringIn:function(){c.addClass(this.element,"in")},isIn:function(){return c.hasClass(this.element,"in")},stack:function(){return c.hasClass(this.element,"stack")||c.removeClass(this.element,"in").addClass(this.element,"stack"),this},isStacked:function(){return c.hasClass(this.element,"stack")},unStack:function(t){return c.removeClass(this.element,"stack"),t&&c.addClass(this.element,"unstack"),this},wasUnStacked:function(){return c.hasClass(this.element,"unstack")},pop:function(){return c.removeClass(this.element,"in").addClass(this.element,"pop"),this},wasPopped:function(){return c.hasClass(this.element,"pop")},reset:function(t){if("string"==typeof t)c.removeClass(this.element,t);else{var e=this;t.forEach(function(t){c.removeClass(e.element,t)})}}},p.prototype={constructor:p,initialize:function(){},activate:function(){},deactivate:function(){},destroy:function(){}},m.defineView=function(t,e){var n=d(t,e);n.factory=e},m.views=function(t){var e;for(var n in t)s.ownsProperty(t,n)&&(e=d(n),e.templatePath=t[n])},m.view=function(t,e){var n=d(t);n.templatePath=e},m}();return u});