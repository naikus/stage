!function(e,t){var n=t(e);"function"==typeof define&&define.amd?define(function(){return n}):"object"==typeof module&&module.exports?module.exports=n:e.Stage=n}("undefined"==typeof window?this:window,function(e,t){var n=e.document,r=e.setTimeout,i=(e.setInterval,e.XMLHttpRequest),o=e.getComputedStyle,a=e.requestAnimationFrame,s=function(){var e=Array.prototype,t=Object.prototype,n=e.slice,r=n,i=t.toString;return{shallowCopy:function(){for(var e,t=arguments[0],n=Array.prototype.slice.call(arguments,1),r=0,i=n.length;r<i;r++){e=n[r];for(var o in e)t[o]=e[o]}return t},ownsProperty:function(e,t){if(e.hasOwnProperty)return e.hasOwnProperty(t);var n=e[t];return"undefined"!=typeof n&&e.constructor.prototype[t]!==n},slice:function(e,t,n){var o,a,s=e.length,l=t||0,c=n||s;if("[object Array]"===i.call(e))o=r.call(e,l,c);else for(c<0&&(c=s-c),o=[],a=l;a<c;a++)o[o.length]=e[a];return o},trim:function(e){return e.replace(/^\s+|\s+$/g,"")}}}(),l=function(){function t(e,t,n){var r,i=v.cloneNode();return t+="",i.innerHTML=["<",e,">",t,"</",e,">"].join(""),r=n?i.firstChild.firstChild.childNodes:i.firstChild.childNodes}function r(e){return u[e]||(u[e]=new RegExp("(^|\\s+)"+e+"(?:\\s+|$)"))}function i(e,t){var n=e.classList;return!(!n||!t)&&(n.add(t),!0)}function a(e,t){var n=e.classList;return!(!n||!t)&&(n.remove(t),!0)}function l(e,t){return r(t).test(e.className)}function c(e,t,r){var i=n.createEvent("Event");return i.initEvent(e,r.bubbles,r.cancelable),i.srcElement=t,i}var u={},d=!!e.ActiveXObject,f=/^\s*<(!--\s*.*)?(\w+)[^>]*>/,v=n.createElement("div"),h=n.createElement("table"),p=n.createElement("tr"),m={"*":v,tbody:h,tfoot:h,tr:n.createElement("tbody"),td:p,th:p},w=typeof("function"===e.Event);return{selectOne:function(e,t){return"string"==typeof e?(t||n).querySelector(e):e},select:function(e,t){return"string"==typeof e?(t||n).querySelectorAll(e):e},asFragment:function(e,r){var i,o,a,l,c;r||(o=f.exec(e),r=o?o[2]:null),i=(m[r]||v).cloneNode(),d?(l=i.tagName.toLowerCase(),"tbody"===l||"table"===l||"thead"===l||"tfoot"===l?a=t("table",e,!0):(i.innerHTML=""+e,a=i.childNodes)):(i.innerHTML=""+e,a=i.childNodes),a=s.slice(a),c=n.createDocumentFragment();for(var u=0,h=a.length;u<h;u+=1)c.appendChild(a[u]);return c},dispatchEvent:function(e,t){var r,i=t.element||n,o=t.data;if(w)try{r=new Event(e,{bubbles:t.bubbles||!1,cancelable:t.cancelable||!1})}catch(a){r=c(e,i,t)}else r=c(e,i,t);for(var l in o)s.ownsProperty(o,l)&&(r[l]=o[l]);i.dispatchEvent(r)},hasClass:l,addClass:function(e,t){var n;if(e.length)for(var r=0,o=e.length;r<o;r+=1)n=e[r],l(n,t)||i(n,t)||(n.className+=" "+t);else n=e,l(n,t)||i(n,t)||(n.className+=" "+t);return this},removeClass:function(e,t){var n;if(e.length)for(var i=0,o=e.length;i<o;i+=1)n=e[i],l(n,t)&&!a(n,t)&&(n.className=s.trim(n.className.replace(r(t),"$1")));else n=e,l(n,t)&&!a(n,t)&&(n.className=s.trim(n.className.replace(r(t),"$1")));return this},getComputedStyle:function(e){return o?o(e):e.currentStyle},data:function(e){var t=arguments[1],n=arguments[2],r=e.__stagedata__;return r||(r=e.__stagedata__={}),2===arguments.length?r[t]:(3===arguments.length&&(r[t]=n),this)}}}(),c=function(){function t(e){var t=new i,n=!1,r=e.path,o=e.method||"GET",a=e.success,s=e.fail,l="undefined"==typeof e.timeout?3e4:e.timeout;t.open(o,r,!0),t.timeout=l,t.addEventListener("readystatechange",function(){var e,r=t.readyState;2!==r&&3!==r||(n=!0),4===r&&(e=t.status,e>=200&&e<400||0===e&&n?a&&a(t):s&&s(e,t))}),t.addEventListener("timeout",function(){s&&s("timeout",t)}),t.send()}function o(e,t,r){var i=n.createElement("script");i.textContent=r?"(function() {\n"+e+"\n})();":e,t.appendChild(i)}function c(e,t,r){var i=n.createElement("script");"onreadystatechange"in i?i.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||r(e)}:i.onload=function(){r(e)},i.src=e,i.async=1,t.appendChild(i)}function u(e,r,i){t({path:e,method:"GET",success:function(t){var a=n.createElement("div"),u=l.asFragment(t.responseText),d=s.slice(l.select("script",u)).filter(function(e){var t=e.getAttribute("type")||"text/javascript";return t.indexOf("/javascript")!==-1}),f=function(){var t,n;d.length?(t=d.shift(),(n=t.getAttribute("src"))?c(n,a,f):(o(t.textContent,a),f())):i({path:e,error:!1,element:a})};d.forEach(function(e){e.parentNode.removeChild(e)}),a.className="view-holder",a.setAttribute("data-view-template",e),a.appendChild(u),r.appendChild(a),f()},fail:function(t,n){i({path:e,error:t||!0,xhr:n})}})}function d(e){var t=m[e];return t||(t=m[e]={id:e}),t}function f(e,t,n){this.id=e,this.element=t,this.controller=n}function v(){function e(e){var t=l.getComputedStyle(e),n=t["transition-property"];return n?n.split(",").length:0}var t,n,r,i=!1;return eventCount={},{name:function(){return arguments.length?(t=arguments[0],this):t},from:function(t){return n=t.id,eventCount[t.id]=e(t.element),this},to:function(t){return r=t.id,eventCount[t.id]=e(t.element),this},transitionEnded:function(e){var t;return eventCount[e.id]-=1,t=!eventCount[e.id],i=eventCount[n]||eventCount[r],t},inProgress:function(){return arguments.length?(i=arguments[0],this):i},clear:function(){delete eventCount[n],delete eventCount[r],i=!1,n=r=null}}}function h(e){var t=e;return{getViewPort:function(){return t.getViewPort()},pushView:function(e,n){return t.pushView(e,n)},popView:function(e){return t.popView(e)},currentView:function(){return t.currentView()},previousView:function(){return t.previousView()}}}function p(e){function t(e){var t,n,r='[data-view="'+e+'"]',i=l.selectOne(r,I),o=m[e];if(!i)throw new Error("UI for view "+e+" not found.");return i.addEventListener(C.transition.end||"transitionend",P),i.addEventListener(C.animation.end||"animationend",P),t=o.factory(S,i),w.forEach(function(e){"undefined"==typeof t[e]&&(t[e]=g)}),n=T[e]=new f(e,i,t)}function n(e,n){var i,o=T[e],s="transition"in n?n.transition:O,u=function(){i&&k("out",i),k("in",o),y(function(){i&&c(i,s),a(o,s)})},d=x.name();if(d!==s&&(x.name(s),d&&l.removeClass(I,d),l.addClass(I,s)),i=L.length?L[L.length-1]:null){if(i.id===e)return i.controller.update(n),void x.clear();x.from(i),n.fromView=i.id}l.addClass(I,"view-transitioning"),o?o.unStack().show(!0):(o=t(e,n),o.show(!0),o.controller.initialize(n)),o.transition=s,x.to(o),i&&i.controller.deactivate();var f=o.controller.activate;2===f.length?o.controller.activate(n,function(){r(u,A.transitionDelay)}):(o.controller.activate(n),r(u,A.transitionDelay)),L.push(o)}function i(e,t){var n,i,a,s=x.name(),c=function(){k("out",n),k("in",i),y(function(){d(n,s),p(i,s)})};if(n=L.pop(),t){if(a=o(t),a===-1)throw L.push(n),x.clear(),new Error("View "+t+" is not on stack");i=L[a],L.splice(a+1,L.length-(a+1))}else i=L[L.length-1];i.stack(),l.addClass(I,"view-transitioning"),i.show(!0),x.from(n).to(i),n.controller.deactivate();var u=i.controller.activate;2===u.length?i.controller.activate(e,function(){r(c,A.transitionDelay)}):(i.controller.activate(e),r(c,A.transitionDelay))}function o(e){var t,n;for(t=0,n=L.lenth;t<n&&L[t].id!==e;t+=1);return t===n?-1:t}function a(e,t){e.bringIn(),C.transition.end&&t||P({target:e.element,propertyName:b})}function c(e,t){e.stack(),C.transition.end&&t||P({target:e.element,propertyName:b})}function d(e,t){e.pop(),C.transition.end&&t||P({target:e.element,propertyName:b})}function p(e,t){e.unStack("unstack").bringIn(),C.transition.end&&t||P({target:e.element,propertyName:b})}function V(e,t){l.dispatchEvent("viewtransition"+e,{element:I,data:{viewId:t.id}}),l.dispatchEvent("transition"+e,{element:t.element})}function k(e,t){l.dispatchEvent("beforeviewtransition"+e,{element:I,cancelable:!0,data:{viewId:t.id}}),l.dispatchEvent("beforetransition"+e,{element:t.element})}function P(e){var t,n,r,i,o=e.target,a=o.getAttribute("data-view");a&&(t=T[a],x.transitionEnded(t)&&(t.isIn()?(t.wasUnStacked()&&t.reset("unstack"),n="in"):t.wasPopped()?(t.reset(["showing","pop"]),n="out"):t.isStacked()&&(t.show(!1),n="out"),V(n,t),x.inProgress()||(x.clear(),l.removeClass(I,"view-transitioning"),r=x.name(),i=L[L.length-1],r!==i.transition&&(l.removeClass(I,r).addClass(I,i.transition),x.name(i.transition)))))}var S,N,A=s.shallowCopy({},E,e),I=l.selectOne(A.viewport),T={},x=v(),L=[];if(console.debug("Stage options ",A),!I||1!==I.nodeType)throw new Error("Use a valid element as view port");var O=A.transition;return O&&(l.addClass(I,O),x.name(O)),N={getViewPort:function(){return I},pushView:function(e,t){var r=this,i=T[e],o=s.shallowCopy({},t);return x.inProgress()?void console.log("pushView() View transitioin in progress. Ignoring this call"):(x.inProgress(!0),void(i?n(e,o):r.loadView(e,function(t){if(t.error)throw x.clear(),new Error("Error loading view: "+t.error);n(e,o)})))},popView:function(e){var t=s.shallowCopy({},e),n=t.toView;if(x.inProgress())return void console.debug("popView() View transitioin in progress. Ignoring this call");if(L.length<2)throw new Error("Can't pop. One or less view(s)");x.inProgress(!0),i(t,n)},currentView:function(){var e=L[L.length-1];return e?e.id:null},previousView:function(){var e;return L.length>=2?(e=L[L.length-2],e?e.id:null):null},indexOfView:function(e){var t=-1;return L.some(function(n,r){return n.id===e&&(t=r,!0)}),t},isTransitionInProgress:function(){return x.inProgress()},loadView:function(e,t){var n=m[e];if(!n)throw new Error("Don't know of view: "+e);n.factory?t({viewId:e,error:!1}):u(n.templatePath,I,function(n){t({viewId:e,error:n.error})})},getViewController:function(e){return T[e].controller}},S=h(N),N}var m={},w=["initialize","activate","update","deactivate","destroy"],g=function(){},y=a||e.mozRequestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return r(e,1e3/60)},C=function(){var e=["","Webkit","Moz","O","ms","MS"],t=["transitionend","webkitTransitionEnd","transitionend","oTransitionEnd","MSTransitionEnd"],r=["animationend","webkitAnimationEnd","animationend","oAnimationEnd","animationend"],i=n.createElement("div"),o=i.style;return{transition:function(){for(var n,r,i=0,a=e.length;i<a;i+=1)if(n=e[i],r=n?n+"Transition":"transition","undefined"!=typeof o[r])return{property:r,end:t[i]};return{}}(),animation:function(){for(var t,n,i=0,a=e.length;i<a;i+=1)if(t=e[i],n=t?t+"Animation":"animation","undefined"!=typeof o[n])return{property:n,end:r[i]};return{}}()}}(),E={transitionDelay:150,transition:"slide"},b="no-transition";return f.prototype={constructor:f,show:function(e){return e===!1?l.removeClass(this.element,"showing"):l.addClass(this.element,"showing"),this},bringIn:function(){l.addClass(this.element,"in")},isIn:function(){return l.hasClass(this.element,"in")},stack:function(){return l.hasClass(this.element,"stack")||l.removeClass(this.element,"in").addClass(this.element,"stack"),this},isStacked:function(){return l.hasClass(this.element,"stack")},unStack:function(e){return l.removeClass(this.element,"stack"),e&&l.addClass(this.element,"unstack"),this},wasUnStacked:function(){return l.hasClass(this.element,"unstack")},pop:function(){return l.removeClass(this.element,"in").addClass(this.element,"pop"),this},wasPopped:function(){return l.hasClass(this.element,"pop")},reset:function(e){if("string"==typeof e)l.removeClass(this.element,e);else{var t=this;e.forEach(function(e){l.removeClass(t.element,e)})}}},p.defineView=function(e,t){var n=d(e,t);n.factory=t},p.views=function(e){var t;for(var n in e)s.ownsProperty(e,n)&&(t=d(n),t.templatePath=e[n])},p.view=function(e,t){var n=d(e);n.templatePath=t},p}();return c});